#!/usr/bin/env coffee

log                 = require './lib/log'
path                = require 'path'
{Promise}           = require 'rsvp'
{exec}              = require 'child_process'

(cmd = require 'commander')
  .version('0.0.1')
  .option('-p, --port [PORT]', 'Port to listen on', 8000)
  .parse(process.argv)

new Promise (done, fail) ->
  exec "git status", (err, out) ->
    if out.match /working directory clean/
      done()
    else
      fail "You must have a clean working directory to deploy.  Check the output of `git status`."
.then ->
  new Promise (done, fail) ->
    log.debug "Building site..."
    exec "fetool build -c", (err, out) ->
      if err
        fail err
      else
        done()
.then ->
  new Promise (done, fail) ->
    exec "git co master && sleep 0.1s; cp -R public/* ./ && git add . && sleep 0.1s; git commit -m 'Update' && sleep 0.1s; git push origin master", (err, stdout) ->
      if err
        exec "git clean -df && git co source", ->
          if stdout.match /nothing to commit/
            fail "There were no changes since the last deploy"
          else
            fail [err, stdout].join '\n'
      else
        exec "git co source", ->
          log.debug stdout
          done()
.then ->
  log "Success!"
.then null, (err) ->
  log.error "Error during deploy: #{err}"
  log.error "Cleanup was attempted; you should make sure nothing is busted."
  log.error "Specifically consider `git branch -f master master~`"
  process.exit()
